# BeatMaster Note Generation Algorithm v1.0

본 문서는 BeatMaster의 핵심 기능인 MIDI 기반 계층형 노트 생성 알고리즘(Layered Fill Algorithm)의 기술 사양을 기술합니다.

## 1. 개요 (Overview)

BeatMaster의 노트 생성 로직은 단순히 MIDI 트랙 하나를 사용하는 것을 넘어, 곡의 풍성함을 물리적인 게임 플레이로 전환하기 위해 **계층형 병합(Layered Merge)** 방식을 채택합니다. 유효한 모든 멜로디 트랙을 분석하고, 우선순위에 따라 빈 공간을 채워 넣음으로써 밀도 지향적이면서도 음악적인 채보를 생성합니다.

## 2. 트랙 분석 및 점수 산정 (Scoring)

모든 MIDI 트랙은 아래 기준에 따라 점수가 매겨지며, 높은 점수 순으로 우선순위(Priority 0 ~ N)가 부여됩니다.

* **기본 점수**: 노트 수(`noteCount`)에 비례.
* **음역대 보너스**: 평균 음계가 고음역대(MIDI index > 60)일 경우 +500점 (멜로디 가능성 높음).
* **키워드 가중치**:
  * `Melody`, `Vocal`, `Lead`, `Main`: +3000점 (최우선)
  * `Piano`, `Key`, `Synth`: +1500점
  * `Guitar`: +1000점
  * `Bass`: -500점 (가장 낮은 우선순위)
* **필터링**: 노트 수가 10개 미만이거나 드럼 채널(9번)인 트랙은 노트 생성 대상에서 제외됩니다 (단, 배경음에는 포함).

## 3. 계층적 병합 로직 (Layered Merge)

병합 시 **Gap Buffer**(충돌 방지 간격)를 활용하여 노트를 유기적으로 배치합니다.

1. **Priority 0 (메인)**: 무조건 전량 채보로 변환.
2. **Priority 1 ~ N (서브)**: 메인 트랙이 '비어있는 시간대'에만 노트를 채워 넣습니다.
    * 새 노트의 `[시작 - Buffer] ~ [끝 + Buffer]` 구간에 이미 상위 트랙의 노트가 있다면 생략합니다.

## 4. 난이도별 세부 설정 (Difficulty Specs)

| 설정 항목 | EASY (Very Chill) | NORMAL (Standard) | HARD (Extreme Chords) |
| :--- | :--- | :--- | :--- |
| **Gap Buffer** | 1000ms (1.0초) | 100ms (0.1초) | 20ms (0.02초) |
| **Min Interval** | 500ms (초당 2개 제한) | 80ms (표준 연타) | 40ms (빠른 연타 허용) |
| **Chord (동시입력)** | 비허용 (단선율) | 비허용 (단선율 위주) | **허용 (지능적 코드 생성)** |
| **트랙 처리** | Gap Fill 방식 적용 | Gap Fill 방식 적용 | **1-2순위 트랙 강제 출력** |

### HARD 모드 특이사항: 지능적 코드 생성

* **Lane-aware Collision**: HARD 모드에서는 충돌 검사를 '시간'뿐 아니라 '레인(Lane)' 단위로 수행합니다. 시간대가 겹쳐도 레인만 다르면 동시에 출력되도록 하여 음악의 화성(Chord)을 플레이로 구현합니다.
* **Double Layer**: 1순위와 2순위 트랙을 모두 Primary로 간주하여, 두 멜로디가 겹치는 구간에서 역동적인 동시 입력 패턴을 생성합니다.

## 5. 후처리 (Post-processing)

* **노트 길이 보정**: 모든 노트는 최소 100ms의 길이를 보장받으며, 300ms 이상은 '롱노트'로 처리됩니다.
* **레인 물리 충돌 방지**: 생성된 모든 노트는 동일 레인에서 최소 20ms의 간격을 강제하여 시각적인 겹침을 방지합니다.

---
**Version**: 1.0
**Last Updated**: 2026-02-01
